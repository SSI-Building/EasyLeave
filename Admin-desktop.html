<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root {
  --primary-color-start: #11998e;     /* เขียวเข้มสงบ */
  --primary-color-end: #fbc531;       /* ทองคลาสสิก11 */
  --text-color: #2f2f2f;
  --light-text-color: #555;
  --background-color: #f5f7f2;
  --card-background: #fff;
  --shadow-light: 0 4px 15px rgba(0,0,0,0.08);
  --border-color: #e0dbc5;
}

body {
  font-family: 'Prompt', sans-serif;
  background: var(--background-color);
  margin:0;
  padding:40px;
  color:var(--text-color);
  transition: all 0.3s ease;
  box-sizing: border-box;
}

/* โครงหลัก */
.container {
  max-width: 1100px;
  margin:auto;
  position:relative;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}
.container.loaded { opacity: 1; transform: translateY(0); }

/* ส่วนหัว */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
  padding:24px 30px;
  border-radius:16px;
  color:#fff;
  box-shadow:var(--shadow-light);
  margin-bottom:30px;
}
.header-left { display:flex; align-items:center; gap:20px; }
.profile-pic {
  width:70px; height:70px;
  border-radius:50%;
  background:rgba(255,255,255,0.2);
  border:3px solid rgba(255,255,255,0.5);
  object-fit:cover;
}
.greeting { font-size:22px; font-weight:600; }
.motivation { font-size:14px; color:rgba(255,255,255,0.9); margin-top:6px; }

.logout-icon {
  font-size:24px;
  color:#fff;
  cursor:pointer;
  transition: transform 0.2s ease;
}
.logout-icon:hover { transform: scale(1.1); }

/* Dropdown และปุ่ม */
.controls {
  display:flex;
  gap:16px;
  align-items:center;
  margin-bottom:25px;
}
select#employeeSelect {
  flex:1;
  padding:12px 14px;
  border-radius:10px;
  border:1px solid var(--border-color);
  font-size:16px;
  outline:none;
  background-color:#fff;
  transition: border 0.2s ease;
}
select#employeeSelect:focus {
  border-color: var(--primary-color-start);
  box-shadow: 0 0 4px rgba(17,153,142,0.2);
}

.btn {
  background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
  color: white;
  border: none;
  border-radius: 8px;
  padding: 12px 20px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  box-shadow: var(--shadow-light);
  transition: all 0.25s ease;
}
.btn:hover { opacity: 0.9; transform: translateY(-1px); }
.btn:active { transform: translateY(1px); opacity: 0.8; }

/* การ์ดและตาราง */
.table-container {
  background: var(--card-background);
  border-radius:14px;
  box-shadow: var(--shadow-light);
  padding:24px;
}
.info-row {
  display:flex;
  gap:18px;
  margin-bottom:20px;
}
.card {
  flex:1;
  background:var(--card-background);
  border-radius:10px;
  padding:14px 18px;
  box-shadow:var(--shadow-light);
}
.card h4 {
  margin:0 0 6px 0;
  font-size:15px;
  color:var(--light-text-color);
}
.card p {
  margin:0;
  font-weight:600;
  color:var(--text-color);
  font-size:17px;
}

h4.section-title {
  text-align:left;
  margin:12px 0 10px 0;
  color:var(--light-text-color);
  font-weight:600;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:15px;
}
th, td {
  padding:14px;
  text-align:center;
  border-bottom:1px solid var(--border-color);
}
th {
  background: var(--background-color);
  font-weight:600;
  color: var(--text-color);
}
tr:last-child td { border-bottom:none; }

/* โหลดหน้า */
.loading-screen {
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  background-color: var(--background-color);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
  flex-direction: column;
  gap: 20px;
}
.loading-screen.hidden { opacity: 0; pointer-events: none; }
.spinner {
  border: 6px solid var(--border-color);
  border-top: 6px solid var(--primary-color-end);
  border-radius: 50%;
  width: 60px; height: 60px;
  animation: spin 1s linear infinite;
}
.loading-text {
  color: var(--text-color);
  font-size: 1.2em;
  font-weight: 500;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
  <div class="spinner"></div>
  <div class="loading-text">กำลังโหลดข้อมูล...</div>
</div>

<div class="container" id="mainContainer">
  <div class="header">
    <div class="header-left">
      <img id="profilePic" class="profile-pic" src="https://cdn-icons-png.flaticon.com/512/1946/1946429.png" alt="Profile">
      <div>
        <div class="greeting">Admin Dashboard</div>
        <div class="motivation" id="motivation">เลือกพนักงานเพื่อดูสิทธิ์</div>
      </div>
    </div>
    <i class="fas fa-sign-out-alt logout-icon" id="logoutIcon" title="ออกจากระบบ"></i>
  </div>

  <div class="controls">
    <select id="employeeSelect">
      <option value="">-- เลือกพนักงาน --</option>
    </select>
    <button class="btn" id="refreshBtn" title="รีเฟรชรายชื่อ">
      <i class="fas fa-sync-alt"></i> รีเฟรช
    </button>
  </div>

  <div class="table-container">
    <div class="info-row">
      <div class="card">
        <h4>ชื่อพนักงาน</h4>
        <p id="empName">-</p>
      </div>
    </div>

    <div id="remainBlock">
      <h4 class="section-title">สิทธิลาคงเหลือ</h4>
      <table id="remainTable"></table>
    </div>

    <div id="usedBlock" style="margin-top:20px">
      <h4 class="section-title">สิทธิลาที่ใช้</h4>
      <table id="usedTable"></table>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const name = sessionStorage.getItem("adminName");
  const greetingDiv = document.querySelector(".greeting");
  if (greetingDiv) greetingDiv.textContent = name ? `สวัสดีคุณ ${name}` : "Admin Dashboard";
});

const EMP_LIST_URL = "https://script.google.com/macros/s/AKfycbyxbbP1-GJdavLejrM8Yi-w0Q_c4BFj0V-Nliv52fV_Vhen7rpZenq5t5gwwTsFtBzT_A/exec";
const BALANCE_URL = "https://script.google.com/macros/s/AKfycbypMCM0IUoQuBiKy_W28zuwufN0s1XR6tIczx8A23srghg_w-wKuhbbiSeXGyFlL4JHNA/exec";

const employeeSelect = document.getElementById('employeeSelect');
const empNameEl = document.getElementById('empName');
const remainTable = document.getElementById('remainTable');
const usedTable = document.getElementById('usedTable');
const motivationEl = document.getElementById('motivation');
const loadingScreen = document.getElementById('loadingScreen');
const mainContainer = document.getElementById('mainContainer');
const refreshBtn = document.getElementById('refreshBtn');

const messages = [
  "ยินดีต้อนรับเข้าสู่ระบบ!", "ดีใจที่เจอคุณวันนี้!", "สู้ ๆ กับวันใหม่ครับ!",
  "ขอให้วันนี้เป็นวันที่ดี!", "ยิ้มรับความท้าทายวันนี้!", "ขอให้มีความสุขกับการทำงาน!"
];

function formatMinutesObject(minutes) {
  if (isNaN(minutes) || minutes === null) return { days: 0, hours: 0, mins: 0 };
  const days = Math.floor(minutes / 480);
  const hours = Math.floor((minutes % 480) / 60);
  const mins = minutes % 60;
  return { days, hours, mins };
}
function displayValue(val) { return (val === 0 ? "-" : val); }

async function loadEmployeeList() {
  employeeSelect.innerHTML = '<option value="">-- กำลังโหลดรายชื่อ... --</option>';
  try {
    const res = await fetch(EMP_LIST_URL);
    const data = await res.json();
    employeeSelect.innerHTML = '<option value="">-- เลือกพนักงาน --</option>';
    data.forEach(emp => {
      if (emp.name && emp.lineId) {
        const opt = document.createElement('option');
        opt.value = emp.lineId;
        opt.textContent = emp.name;
        employeeSelect.appendChild(opt);
      }
    });
    loadingScreen.classList.add('hidden');
    mainContainer.classList.add('loaded');
  } catch (err) {
    console.error("โหลดรายชื่อไม่สำเร็จ:", err);
    employeeSelect.innerHTML = '<option value="">-- โหลดรายชื่อไม่สำเร็จ --</option>';
    loadingScreen.classList.add('hidden');
    mainContainer.classList.add('loaded');
  }
}

async function loadBalanceForUser(lineUserId) {
  try {
    const url = `${BALANCE_URL}?action=getBalance&userId=${encodeURIComponent(lineUserId)}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) { alert(data.error); clearTables(); return; }

    motivationEl.textContent = messages[Math.floor(Math.random() * messages.length)];
    empNameEl.textContent = employeeSelect.selectedOptions[0]?.textContent || "-";

    const remainRows = [
      { type: 'ลาพักร้อน', min: data.set1[3] },
      { type: 'ลาป่วย', min: data.set1[4] },
      { type: 'ลากิจ', min: data.set1[5] }
    ];
    remainTable.innerHTML = `<tr><th>ประเภทการลา</th><th>วัน</th><th>ชั่วโมง</th><th>นาที</th></tr>` +
      remainRows.map(r => {
        const t = formatMinutesObject(r.min);
        return `<tr><td>${r.type}</td><td>${displayValue(t.days)}</td><td>${displayValue(t.hours)}</td><td>${displayValue(t.mins)}</td></tr>`;
      }).join('');

    const usedRows = [
      { type: 'ลาพักร้อน', min: data.set2[3] },
      { type: 'ลาป่วย', min: data.set2[4] },
      { type: 'ลากิจ', min: data.set2[5] },
      
    ];
    usedTable.innerHTML = `<tr><th>ประเภทการลา</th><th>วัน</th><th>ชั่วโมง</th><th>นาที</th></tr>` +
      usedRows.map(r => {
        const t = formatMinutesObject(r.min);
        return `<tr><td>${r.type}</td><td>${displayValue(t.days)}</td><td>${displayValue(t.hours)}</td><td>${displayValue(t.mins)}</td></tr>`;
      }).join('');

  } catch (err) {
    console.error("โหลด balance ผิดพลาด:", err);
    alert("เกิดข้อผิดพลาดในการโหลดข้อมูล");
    clearTables();
  }
}

function clearTables() {
  remainTable.innerHTML = '';
  usedTable.innerHTML = '';
  empNameEl.textContent = '-';
}

employeeSelect.addEventListener('change', e => {
  const lineId = e.target.value;
  if (!lineId) { clearTables(); motivationEl.textContent = "เลือกพนักงานเพื่อดูสิทธิ์"; return; }
  remainTable.innerHTML = `<tr><td colspan="4" style="padding:14px;text-align:center">⏳ กำลังโหลด...</td></tr>`;
  usedTable.innerHTML = `<tr><td colspan="4" style="padding:14px;text-align:center">⏳ กำลังโหลด...</td></tr>`;
  loadBalanceForUser(lineId);
});

refreshBtn.addEventListener('click', () => {
  loadingScreen.classList.remove('hidden');
  loadEmployeeList();
});
document.getElementById('logoutIcon').addEventListener('click', () => { window.location.href = 'Dashboard-admin.html'; });
window.onload = loadEmployeeList;
</script>
</body>
</html>
